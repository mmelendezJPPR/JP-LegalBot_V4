<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="icon" href="/static/favicon.ico">  
    <link rel="stylesheet" href="/static/css/style.css">
    <title>JP_IA - Sistema Experto de Planificaci√≥n</title>
   
</head>
<body>
    <!-- Bot√≥n men√∫ m√≥vil -->
    <button class="mobile-menu-btn" onclick="toggleMobileMenu()">‚ò∞</button>
    
    <!-- Overlay m√≥vil -->
    <div class="mobile-overlay" id="mobileOverlay" onclick="toggleMobileMenu()"></div>

    <div class="app-container">
        <!-- Sidebar -->
        <aside class="sidebar">
            <div class="sidebar-header">
                <div class="logo-container">
                    <img src="/static/JPlogo.png" alt="JP Logo" class="logo-image">
                </div>
            </div>

            <nav class="specialists-nav">
                <h3>Especialistas</h3>
                
                <button class="specialist-btn active" data-specialist="general">
                    <div class="specialist-icon">üß†</div>
                    <div class="specialist-info">
                        <div class="specialist-name">Chat General</div>
                        <div class="specialist-desc">An√°lisis completo</div>
                    </div>
                </button>
            </nav>

            <button class="new-chat-btn" onclick="newChat()">
                <span>‚ûï</span>
                <span>Nueva Conversaci√≥n</span>
            </button>

            <button class="logout-btn" onclick="logout()">
                <span>üö™</span>
                <span>Cerrar Sesi√≥n</span>
            </button>
        </aside>

        <!-- √Årea de Chat -->
        <main class="chat-area">
            <header class="chat-header">
                <!-- IDs para compatibilidad con static/js/app.js -->
                <h2 id="specialistTitle">Experto JP_IA</h2>
                <p id="specialistDescription">An√°lisis Inteligente de Reglamentos de Planificaci√≥n</p>
                <div class="status-badge">
                    <div class="status-dot"></div>
                    Sistema Activo
                </div>
            </header>

            <div class="messages-container" id="messagesContainer">
                <div id="chatContainer" class="chat-messages" style="width: 100%;">
                    <div class="welcome-message" id="welcomeMessage">
                        <div class="welcome-content">
                            <div class="assistant-avatar">
                               <img src="/static/JP_V2.png" alt="JP Logo" class="logo-image-avatar">
                            </div>
                            <div class="welcome-text">
                                <h3>¬°Hola! Soy JP_IA</h3>
                                <p>Tu asistente experto en planificaci√≥n y reglamentos de Puerto Rico. Puedo ayudarte con consultas sobre permisos, zonificaci√≥n, construcci√≥n y mucho m√°s.</p>
                            </div>
                        </div>
                        
                        <div class="suggestions">
                            <h4>Consultas populares</h4>
                            <div class="suggestion-cards">
                                <button class="suggestion-card" onclick="quickQuery('¬øQu√© permisos necesito para construir una casa?')">
                                    <div class="suggestion-icon">üè†</div>
                                    <div class="suggestion-content">
                                        <div class="suggestion-title">Permisos de construcci√≥n</div>
                                        <div class="suggestion-desc">Requisitos para edificar</div>
                                    </div>
                                </button>
                                <button class="suggestion-card" onclick="quickQuery('¬øCu√°l es el proceso de zonificaci√≥n?')">
                                    <div class="suggestion-icon">üóÇÔ∏è</div>
                                    <div class="suggestion-content">
                                        <div class="suggestion-title">Proceso de zonificaci√≥n</div>
                                        <div class="suggestion-desc">Clasificaci√≥n de terrenos</div>
                                    </div>
                                </button>
                                <button class="suggestion-card" onclick="quickQuery('Regulaciones para sitios hist√≥ricos')">
                                    <div class="suggestion-icon">üèõÔ∏è</div>
                                    <div class="suggestion-content">
                                        <div class="suggestion-title">Sitios hist√≥ricos</div>
                                        <div class="suggestion-desc">Patrimonio y conservaci√≥n</div>
                                    </div>
                                </button>
                                <button class="suggestion-card" onclick="quickQuery('¬øC√≥mo solicitar un permiso de uso?')">
                                    <div class="suggestion-icon">üìã</div>
                                    <div class="suggestion-content">
                                        <div class="suggestion-title">Permiso de uso</div>
                                        <div class="suggestion-desc">Tramitaci√≥n y requisitos</div>
                                    </div>
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="input-area">
                <div class="typing-indicator" id="typingIndicator">
                    <div class="assistant-avatar-small">
                        <svg viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                            <path d="M12 2C13.1 2 14 2.9 14 4C14 5.1 13.1 6 12 6C10.9 6 10 5.1 10 4C10 2.9 10.9 2 12 2ZM21 9V7L15 1H5C3.89 1 3 1.89 3 3V19A2 2 0 0 0 5 21H19A2 2 0 0 0 21 19V9M19 9H14V4L19 9Z" fill="currentColor"/>
                        </svg>
                    </div>
                    <div class="typing-animation">
                        <div class="typing-dots">
                            <div class="typing-dot"></div>
                            <div class="typing-dot"></div>
                            <div class="typing-dot"></div>
                        </div>
                        <span class="typing-text">JP_IA est√° escribiendo...</span>
                    </div>
                </div>

                <div class="input-wrapper">
                    <div class="input-container">
                        <textarea 
                            id="messageInput" 
                            placeholder="Preg√∫ntame sobre reglamentos de planificaci√≥n..."
                            rows="1"
                            onkeydown="handleKeyPress(event)"
                            maxlength="1000"
                        ></textarea>
                        <div class="input-actions">
                            <!-- Attachment button intentionally removed; keep wrapper for alignment -->
                        </div>
                    </div>

                    <button class="send-btn" onclick="sendMessage()" title="Enviar mensaje">
                        <svg viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                            <path d="M2 21L23 12L2 3V10L17 12L2 14V21Z" fill="currentColor"/>
                        </svg>
                    </button>
                    <!-- Bot√≥n para que un planificador guarde una correcci√≥n manual -->
                    <button class="learn-btn" onclick="openLearnModal()" title="Guardar correcci√≥n" style="margin-left:8px;">
                        üíæ
                    </button>
                </div>
            </div>
        </main>
    </div>

    <!-- Modal simple para enviar correcci√≥n manual -->
    <div id="learnModal" style="display:none; position:fixed; right:20px; bottom:80px; background:white; border:1px solid #ddd; padding:12px; box-shadow:0 4px 12px rgba(0,0,0,0.15); width:320px; z-index:2000;">
        <h4 style="margin:0 0 8px 0;">Guardar correcci√≥n</h4>
        <textarea id="learnCorrection" placeholder="Escribe la correcci√≥n o la respuesta que quieres que el sistema recuerde" rows="4" style="width:100%;"></textarea>
        <input id="learnOriginalQuery" placeholder="(Opcional) Consulta original" style="width:100%; margin-top:8px;" />
        <div style="text-align:right; margin-top:8px;">
            <button onclick="submitLearn()" style="margin-right:8px;">Guardar</button>
            <button onclick="closeLearnModal()">Cancelar</button>
        </div>
    </div>

    <!-- Cargar el script principal del frontend -->
    <script src="/static/js/app.js"></script>
    <script>
        function openLearnModal(){
            document.getElementById('learnModal').style.display = 'block';
        }
        function closeLearnModal(){
            document.getElementById('learnModal').style.display = 'none';
        }

        async function submitLearn(){
            const correction = document.getElementById('learnCorrection').value;
            const original = document.getElementById('learnOriginalQuery').value;
            if(!correction || correction.trim().length < 5){
                alert('Escribe una correcci√≥n v√°lida (m√≠nimo 5 caracteres).');
                return;
            }

            try{
                const payload = { correction: correction, original_query: original };
                const res = await fetch('/learn', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });
                const j = await res.json();
                if(res.ok && j.success){
                    alert('Correcci√≥n guardada: ' + j.fact_id);
                    closeLearnModal();
                    document.getElementById('learnCorrection').value = '';
                    document.getElementById('learnOriginalQuery').value = '';
                } else {
                    alert('Error guardando correcci√≥n: ' + (j.message || res.statusText));
                }
            } catch(err){
                alert('Error enviando correcci√≥n: ' + err);
            }
        }
    </script>
</body>
</html>